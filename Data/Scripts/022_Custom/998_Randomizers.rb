SPECIAL_POKEMON = {
  :STARTER => [:BULBASAUR, :CHARMANDER, :SQUIRTLE, :CHIKORITA, :CYNDAQUIL, :TOTODILE, :TREECKO, :TORCHIC, :MUDKIP, :TURTWIG, :CHIMCHAR, :PIPLUP, :SNIVY, :TEPIG, :OSHAWOTT, :CHESPIN, :FENNEKIN, :FROAKIE, :ROWLET, :LITTEN, :POPPLIO, :GROOKEY, :SCORBUNNY, :SOBBLE, :SPRIGATITO, :FUECOCO, :QUAXLY],
  :ASHLEYGIFT => :KUBFU,
  :ARTEMISTRADE => [:ZORUA, :TROPIUS],
  :FLIMSYSTATIC => :KLAWF,
  :DAYCAREGIFT => :TOGEPI,
  :HUBRISTRADE => [:MAROWAK_1, :MAROWAK],
  :FOSSILS => {
    :HELIXFOSSIL => :OMANYTE,
    :DOMEFOSSIL  => :KABUTO,
    :OLDAMBER    => :AERODACTYL,
    :ROOTFOSSIL  => :LILEEP,
    :CLAWFOSSIL  => :ANORITH,
    :SKULLFOSSIL => :CRANIDOS,
    :ARMORFOSSIL => :SHIELDON,
    :ODDKEYSTONE => :SPIRITOMB,
    :COVERFOSSIL => :TIRTOUGA,
    :PLUMEFOSSIL => :ARCHEN,
    :JAWFOSSIL   => :TYRUNT,
    :SAILFOSSIL  => :AMAURA
  },
  :MINING => :GLIMMET,
  :FOSSILS8 => [:DRACOZOLT, :ARCTOZOLT, :DRACOVISH, :ARCTOVISH],
  :RIDEPOKEMON => :CYCLIZAR,
  :BLITZ => :SPHEAL,
  :SMITHEGG => :EEVEE,
  :JALSINTRADE => [:CORSOLA_1, :CORSOLA],
  :ROUTE308 => :SUDOWOODO,
  :CASINO => [:RALTS, :TYROGUE, :CASTFORM, :ROTOM, :PORYGON, :DRATINI, :TYPENULL],
  :DIMTRADE => [:SANDSLASH_1, :SANDSLASH],
  :POLTERSTATIC => :DRIFLOON,
  :POLTERTRADE => [:VULPIX_1, :VULPIX],
  :ROUTE312 => :SNORLAX,
  :SHRINE => [
    [:ARTICUNO, :ZAPDOS, :MOLTRES, :RAIKOU, :ENTEI, :SUICUNE, :UXIE, :MESPRIT, :AZELF, :CRESSELIA, :DARKRAI, :COBALION, :TERRAKION, :VIRIZION, :TORNADUS, :THUNDURUS, :LANDORUS, :REGIROCK, :REGICE, :REGISTEEL, :REGIELEKI, :REGIDRAGO, :TAPUKOKO, :TAPULELE, :TAPUBULU, :TAPUFINI, :TINGLU, :CHIENPAO, :WOCHIEN, :CHIYU],
    [:MEWTWO, :HEATRAN, :HOOH, :LUGIA, :RAYQUAZA, :KYOGRE, :GROUDON, :DIALGA, :PALKIA, :GIRATINA, :REGIGIGAS, :KYUREM, :RESHIRAM, :ZEKROM, :ZYGARDE, :XERNEAS, :YVELTAL, :ZACIAN, :ZAMAZENTA, :ETERNATUS, :NIHILEGO, :BUZZWOLE, :PHEROMOSA, :XURKITREE, :CELESTEELA, :KARTANA, :GUZZLORD, :POIPOLE, :STAKATAKA, :BLACEPHALON, :ARCEUS, :KORAIDON, :MIRAIDON],
    [:MEW, :CELEBI, :JIRACHI, :DEOXYS, :SHAYMIN, :MANAPHY, :VICTINI, :KELDEO, :MELOETTA, :GENESECT, :MAGEARNA, :MELTAN, :SPECTRIER, :GLASTRIER, :ZARUDE, :MARSHADOW, :VOLCANION, :COSMOG, :COSMOG_1, :CALYREX, :ZERAORA, :HOOPA]
  ],
  :ARCANETRADE => [:GEODUDE_1, :GRAVELER],
  :LIZARNOLDGIFT => [:LATIAS, :LATIOS],
  :BULGARTTRADE => [:FARFETCHD_1, :FARFETCHD],
  :UPILTRADE => [:MRMIME_1, :MRMIME],
  :UPSILONGIFT => :DIANCIE,
  :LIBERTYTRADE => [:SLOWPOKE_1, :SLOWPOKE],
}

DEFAULT_MART = [
  [:POTION,:ANTIDOTE,:PARALYZEHEAL,:BURNHEAL,:AWAKENING,:ICEHEAL],
  [:POKEBALL,:ESCAPEROPE,:REPEL],
  [:GREATBALL,:REVIVE,:SUPERREPEL,:SUPERPOTION],
  [:ETHER,:FULLHEAL],
  [:ELIXIR,:MAXREPEL,:HYPERPOTION],
  [:ULTRABALL],
  [:MAXETHER,:MAXELIXIR],
  [:MAXPOTION],
  [:FULLRESTORE],
  [:CALCIUM,:CARBOS,:HPUP,:IRON,:PPUP,:PROTEIN,:ZINC,:XACCURACY,:XATTACK,:XDEFENSE,:XSPEED,:DIREHIT,:ABILITYURGE,:GUARDSPEC,:XSPDEF,:XSPATK,:ITEMURGE,:RESETURGE],
  [:JOYSCENT,:EXCITESCENT,:VIVIDSCENT,:BERRYJUICE,:ENERGYPOWDER,:ENERGYROOT,:ETHER,:ELIXIR,:COMMONCANDY,:REVIVALHERB],
  [:NETBALL,:DIVEBALL,:NESTBALL,:REPEATBALL,:TIMERBALL,:LUXURYBALL,:DUSKBALL,:TWILIGHTBALL,:HEALBALL,:QUICKBALL,:FASTBALL,:LEVELBALL,:LUREBALL,:HEAVYBALL,:LOVEBALL,:FRIENDBALL,:MOONBALL,:DREAMBALL],
  [:CHARCOAL,:MYSTICWATER,:MAGNET,:MIRACLESEED,:NEVERMELTICE,:BLACKBELT,:POISONBARB,:SOFTSAND,:SHARPBEAK,:TWISTEDSPOON,:SILVERPOWDER,:HARDSTONE,:SPELLTAG,:DRAGONFANG,:BLACKGLASSES,:METALCOAT,:SILKSCARF],
  [:LONELYMINT,:ADAMANTMINT,:NAUGHTYMINT,:BRAVEMINT,:BOLDMINT,:IMPISHMINT,:LAXMINT,:RELAXEDMINT,:MODESTMINT,:MILDMINT,:RASHMINT,:QUIETMINT,:CALMMINT,:GENTLEMINT,:CAREFULMINT,:SASSYMINT,:TIMIDMINT,:HASTYMINT,:JOLLYMINT,:NAIVEMINT,:SERIOUSMINT],
  [:SALAMENCITE,:LOPUNNITE,:LUCARIONITE,:MANECTITE,:AGGRONITE,:TYRANITARITE,:AMPHAROSITE,:PINSIRITE,:GYARADOSITE,:PIDGEOTITE],
  [:SACHET,:REAPERCLOTH,:DAWNSTONE,:DUSKSTONE,:ELECTIRIZER,:RAZORCLAW,:CRACKEDPOT,:MAGMARIZER,:OVALSTONE,:PROTECTOR,:SHINYSTONE,:WHIPPEDDREAM,:SACHET,:DEEPSEASCALE,:DRAGONSCALE,:RAZORFANG,:UPGRADE,:DUBIOUSDISC,:PRISMSCALE,:EVERSTONE,:FIRESTONE,:ICESTONE,:LEAFSTONE,:MOONSTONE,:SUNSTONE,:THUNDERSTONE,:WATERSTONE,:SWEETAPPLE,:TARTAPPLE,:GALARICACUFF,:GALARICAWREATH,:STRAWBERRYSWEET,:LOVESWEET,:BERRYSWEET,:CLOVERSWEET,:FLOWERSWEET,:STARSWEET,:RIBBONSWEET],
  [:LEEK,:LIGHTBALL,:LUCKYPUNCH,:METALPOWDER,:QUICKPOWDER,:THICKCLUB],
  [:DRACOPLATE,:DREADPLATE,:EARTHPLATE,:FISTPLATE,:ICICLEPLATE,:INSECTPLATE,:IRONPLATE,:MEADOWPLATE,:MINDPLATE,:PIXIEPLATE,:SKYPLATE,:SPOOKYPLATE,:STONEPLATE,:TOXICPLATE,:ZAPPLATE,:FLAMEPLATE,:SPLASHPLATE,:SHADOWGEM,:FIREGEM,:WATERGEM,:ELECTRICGEM,:GRASSGEM,:ICEGEM,:FIGHTINGGEM,:POISONGEM,:GROUNDGEM,:FLYINGGEM,:PSYCHICGEM,:BUGGEM,:ROCKGEM,:GHOSTGEM,:DRAGONGEM,:DARKGEM,:STEELGEM,:FAIRYGEM,:NORMALGEM],
  [:ASSAULTVEST,:HEAVYDUTYBOOTS,:QUICKCLAW,:SAFETYGOGGLES,:STICKYBARB,:WEAKNESSPOLICY,:POWERANKLET,:POWERBAND,:POWERBELT,:POWERBRACER,:POWERLENS,:POWERWEIGHT,:ABSORBBULB,:ADRENALINEORB,:BINDINGBAND,:UTILITYUMBRELLA],
  [:BLACKSLUDGE,:CELLBATTERY,:CLEANSETAG,:EJECTBUTTON,:FLAMEORB,:FLOATSTONE,:FLUFFYTAIL,:HONEY,:KINGSROCK,:LIFEORB,:LIGHTCLAY,:LUMINOUSMOSS,:METRONOME,:POKEDOLL,:POKETOY,:PROTECTIVEPADS,:SCOPELENS,:SHELLBELL,:SMOKEBALL,:SNOWBALL,:TOXICORB],
  [:AIRBALLOON,:BIGROOT,:BRIGHTPOWDER,:CHOICEBAND,:CHOICESCARF,:CHOICESPECS,:DESTINYKNOT,:EXPERTBELT,:FOCUSBAND,:LAGGINGTAIL,:MENTALHERB,:MUSCLEBAND,:POWERHERB,:REDCARD,:RINGTARGET,:SHEDSHELL,:WHITEHERB,:WIDELENS,:WISEGLASSES,:ZOOMLENS,:ELECTRICSEED,:GRASSYSEED,:MISTYSEED,:PSYCHICSEED,:PINKNECTAR,:PURPLENECTAR,:REDNECTAR,:YELLOWNECTAR,:ROCKYHELMET,:TERRAINEXTENDER,:ICYROCK,:HEATROCK,:DAMPROCK,:SMOOTHROCK],
  [:FRESHWATER,:SODAPOP,:LEMONADE,:MOOMOOMILK],
  [:GROWTHMULCH,:DAMPMULCH,:STABLEMULCH,:GOOEYMULCH,:REDNECTAR,:YELLOWNECTAR,:PINKNECTAR,:PURPLENECTAR,:LAXINCENSE,:FULLINCENSE,:LUCKINCENSE,:PUREINCENSE,:SEAINCENSE,:WAVEINCENSE,:ROSEINCENSE,:ODDINCENSE,:ROCKINCENSE,:ENERGYPOWDER,:ENERGYROOT,:HEALPOWDER,:REVIVALHERB,:CHERIBERRY,:CHESTOBERRY,:PECHABERRY,:RAWSTBERRY,:ASPEARBERRY,:LEPPABERRY,:ORANBERRY,:PERSIMBERRY,:LUMBERRY,:SITRUSBERRY,:FIGYBERRY,:WIKIBERRY,:MAGOBERRY,:AGUAVBERRY,:IAPAPABERRY,:RAZZBERRY,:BLUKBERRY,:NANABBERRY,:WEPEARBERRY,:PINAPBERRY,:POMEGBERRY,:KELPSYBERRY,:QUALOTBERRY,:HONDEWBERRY,:GREPABERRY,:TAMATOBERRY,:CORNNBERRY,:MAGOSTBERRY,:RABUTABERRY,:NOMELBERRY,:SPELONBERRY,:PAMTREBERRY,:WATMELBERRY,:DURINBERRY,:BELUEBERRY,:OCCABERRY,:PASSHOBERRY,:WACANBERRY,:RINDOBERRY,:YACHEBERRY,:CHOPLEBERRY,:KEBIABERRY,:SHUCABERRY,:COBABERRY,:PAYAPABERRY,:TANGABERRY,:CHARTIBERRY,:KASIBBERRY,:HABANBERRY,:COLBURBERRY,:BABIRIBERRY,:ROSELIBERRY,:CHILANBERRY,:LIECHIBERRY,:GANLONBERRY,:SALACBERRY,:PETAYABERRY,:APICOTBERRY,:LANSATBERRY,:STARFBERRY,:ENIGMABERRY,:MICLEBERRY,:CUSTAPBERRY,:JABOCABERRY,:ROWAPBERRY,:KEEBERRY,:MARANGABERRY,:JOYSCENT,:EXCITESCENT,:VIVIDSCENT],
  [:SHADOWORB]
]

CASINO_MART = [:SMOKEBALL,:WIDELENS,:ZOOMLENS,:METRONOME,:REDFLUTE,:BLUEFLUTE,:YELLOWFLUTE,:WHITEFLUTE,:BLACKFLUTE,:AMULETCOIN,:LUCKYEGG,:SOOTHEBELL,:GIMMIGHOULCOIN,:REDNECTAR,:YELLOWNECTAR,:PINKNECTAR,:PURPLENECTAR,:BUGMEMORY,:DARKMEMORY,:DRAGONMEMORY,:ELECTRICMEMORY,:FAIRYMEMORY,:FIGHTINGMEMORY,:FIREMEMORY,:FLYINGMEMORY,:GHOSTMEMORY,:PSYCHICMEMORY,:ROCKMEMORY,:STEELMEMORY,:WATERMEMORY]

TM_LIST = [:FOCUSPUNCH,:DRAGONCLAW,:WATERPULSE,:CALMMIND,:ROAR,:TOXIC,:HAIL,:BULKUP,:BULLETSEED,:WORKUP,:SUNNYDAY,:TAUNT,:ICEBEAM,:BLIZZARD,:HYPERBEAM,:LIGHTSCREEN,:PROTECT,:RAINDANCE,:GIGADRAIN,:SAFEGUARD,:DAZZLINGGLEAM,:SOLARBEAM,:IRONTAIL,:THUNDERBOLT,:THUNDER,:EARTHQUAKE,:LOWSWEEP,:DIG,:PSYCHIC,:SHADOWBALL,:BRICKBREAK,:DOUBLETEAM,:REFLECT,:SHOCKWAVE,:FLAMETHROWER,:SLUDGEBOMB,:SANDSTORM,:FIREBLAST,:ROCKTOMB,:AERIALACE,:TORMENT,:FACADE,:VOLTSWITCH,:REST,:ATTRACT,:THIEF,:STEELWING,:SKILLSWAP,:SCALD,:OVERHEAT,:ROOST,:FOCUSBLAST,:ENERGYBALL,:FALSESWIPE,:BRINE,:FLING,:CHARGEBEAM,:ENDURE,:DRAGONPULSE,:DRAINPUNCH,:WILLOWISP,:BUGBUZZ,:NASTYPLOT,:EXPLOSION,:SHADOWCLAW,:PAYBACK,:RECYCLE,:GIGAIMPACT,:ROCKPOLISH,:NIGHTSHADE,:STONEEDGE,:AVALANCHE,:THUNDERWAVE,:GYROBALL,:SWORDSDANCE,:STEALTHROCK,:PSYCHUP,:SNARL,:DARKPULSE,:ROCKSLIDE,:XSCISSOR,:SLEEPTALK,:BULLDOZE,:POISONJAB,:DREAMEATER,:GRASSKNOT,:SWAGGER,:PLUCK,:UTURN,:SUBSTITUTE,:FLASHCANNON,:TRICKROOM,:GASTROACID,:DUALCHOP,:DRAININGKISS,:RECOVER,:DEFOG,:WATERFALL,:MOONBLAST,:ROCKCLIMB]

def absorbmons
  mons = []
  SPECIAL_POKEMON[:STARTER].each do |mon|
    s = GameData::Species.get(mon)
    next unless s.moves(true).any? { |m| GameData::Move.get(m[1]).function_code.include?("Heal") }
    moves = []
    s.moves(true).each do |m|
      moves.push(m) if GameData::Move.get(m[1]).function_code.include?("Heal")
    end
    mons.push([s.id, moves])
  end
  return mons
end


class Player < Trainer
  attr_accessor :wild_encounters
  attr_accessor :trainer_pokemon
  attr_accessor :species_abilities
  attr_accessor :species_learnsets
  attr_accessor :species_evolutions
  attr_accessor :randomized_items
  attr_accessor :special_pokemon
  attr_accessor :shard_mart
  attr_accessor :battle_point_mart
  attr_accessor :mart_stock
  attr_accessor :casino_mart
  attr_accessor :tms

  def wild_encounters
    initialize_challenges
    @wild_encounters = pbGetDefaultEncounters if @wild_encounters.nil? || !@challenges[:randomizer_encounter]
    return @wild_encounters
  end

  def trainer_pokemon
    initialize_challenges
    @trainer_pokemon = pbGetDefaultTrainers if @trainer_pokemon.nil? || !@challenges[:randomizer_trainer]
    return @trainer_pokemon
  end

  def species_abilities
    initialize_challenges
    @species_abilities = pbGetDefaultAbilities if @species_abilities.nil? || !@challenges[:randomizer_abilities]
    return @species_abilities
  end

  def species_learnsets
    initialize_challenges
    @species_learnsets = pbGetDefaultLearnsets if @species_learnsets.nil? || !@challenges[:randomizer_learnset]
    return @species_learnsets
  end

  def species_evolutions
    initialize_challenges
    @species_evolutions = pbGetDefaultEvolutions if @species_evolutions.nil? || !@challenges[:randomizer_evolutions]
    return @species_evolutions
  end

  def randomized_items
    initialize_challenges
    @randomized_items = pbGetDefaultItems if @randomized_items.nil? || !@challenges[:randomizer_item]
    return @randomized_items
  end

  def special_pokemon
    initialize_challenges
    @special_pokemon = SPECIAL_POKEMON if @special_pokemon.nil? || !@challenges[:randomizer_special]
    SPECIAL_POKEMON.each_pair do |key, value|
      @special_pokemon[key] = value unless @special_pokemon.has_key?(key)
    end
    return @special_pokemon
  end

  def shard_mart
    initialize_challenges
    @shard_mart = ShardMart_Scene::DEFAULT_SHARD_MART if @shard_mart.nil? || !@challenges[:randomizer_mart]
    return @shard_mart
  end

  def battle_point_mart
    initialize_challenges
    @battle_point_mart = PokemonMartAdapter_BattlePoints::DEFAULT_BATTLE_POINT_MART if @battle_point_mart.nil? || !@challenges[:randomizer_mart]
    return @battle_point_mart
  end

  def mart_stock
    initialize_challenges
    @mart_stock = DEFAULT_MART if @mart_stock.nil? || !@challenges[:randomizer_mart]
    return @mart_stock
  end

  def casino_mart
    initialize_challenges
    @casino_mart = CASINO_MART if @casino_mart.nil? || !@challenges[:randomizer_mart]
    return @casino_mart
  end

  def tms
    initialize_challenges
    @tms = TM_LIST if @tms.nil? || !@challenges[:randomizer_tms]
    return @tms
  end
end

def valid_pokemon(allow_forms = false)
  pokemon = []
  GameData::Species.each do |s|
    next if s.id == :STARTER
    next if s.form > 0 && !allow_forms
    pokemon.push(s.id)
  end
  return pokemon
end

def valid_abilities
  abilities = []
  GameData::Ability.each do |a|
    abilities.push(a.id)
  end
  return abilities
end

def valid_moves
  moves = []
  GameData::Move.each do |m|
    moves.push(m.id)
  end
  return moves
end

def valid_items
  items = []
  GameData::Item.each do |i|
    next if (i.is_important? && !i.is_TM?) || i.flags.include?("WeatherChip")
    items.push(i.id)
  end
  return items
end

def static_encounter(species, level=1)
  pkmn = GameData::Species.get(species)
  $game_temp.overworld_encounter = true
  Pokemon.play_cry(species)
  pbCallBub
  name = pkmn.name
  name_half = (name.length.to_f / 2).ceil
  pbCallBub(2,get_self.id)
  pbMessage(_INTL("{1}!",name[0,name_half]+name[name_half]+name[name_half]))
  if WildBattle.start(species, level)
    pbSetSelfSwitch(get_self.id, "A", true)
  end
  $game_temp.overworld_encounter = false
end

def randomize_overworlds(events = [])
  return if $player.challenges.nil? || !$player.challenges[:randomizer_special]
  mons = valid_pokemon
  events.each do |event_id|
    event = $game_map.events[event_id]
    pages = (event.is_a?(Game_Event) ? event.instance_eval { @event.pages } : event.pages)
    pages.each do |page|
      next if page.graphic.character_name == "" || !(page.graphic.character_name[/Pokemon/i] || page.graphic.character_name[/Follower/i])
      mon = mons.sample
      page.list.each do |command|
        next if command.code != 355
        mon = eval(command.parameters[0].gsub("static_encounter(", "").gsub(")", "").gsub(" ", "").split(",")[0])
      end
      pbChangeEventSprite(event,Pokemon.new(mon, 1, nil, false))
      break
    end
  end
end

def pbGetDefaultEncounters
  encounters = {}
  GameData::Encounter.each do |enc_data|
    encounters[[enc_data.map, enc_data.version]] = [enc_data.id, enc_data.step_chances, enc_data.types]
  end
  return encounters
end

def pbGetDefaultTrainers
  trainers = {}
  GameData::Trainer.each do |trainer_data|
    trainer_version = trainer_data.version || 0
    trainers[trainer_data.id] = trainer_data.pokemon
  end
  return trainers
end

def pbGetDefaultAbilities
  abilities = {}
  GameData::Species.each do |s|
    next if s.id == :STARTER
    abilities[s.id] = [s.abilities, s.hidden_abilities]
  end
  return abilities
end

def pbGetDefaultLearnsets
  learnsets = {}
  GameData::Species.each do |s|
    learnsets[s.id] = s.moves(true)
  end
  return learnsets
end

def pbGetDefaultEvolutions
  evolutions = {}
  GameData::Species.each do |s|
    evolutions[s.id] = s.evolutions
  end
  return evolutions
end

def pbGetDefaultItems
  items = {}
  mapData = Compiler::MapData.new
  maps = mapData.mapinfos.keys.sort
  maps.each do |id|
    map = mapData.getMap(id)
    map.events.each_value do |event|
      pages = (event.is_a?(RPG::Event) ? event.pages : event.instance_eval { @event.pages })
      next if !event || pages.length == 0
      item_list = getEventItem(event) # [[#<GameData::Item>, 1], [#<GameData::Item>, 1]] (0 = field, 1 = gift, 2 = berry)
      next if item_list == []
      final_list = []
      item_list.each do |item|
        next if item[1] == 2
        next if (item[0].is_important? && !item[0].is_TM?) || item[0].flags.include?("WeatherChip")
        final_list.push(item[0].id)
      end
      items[[id, event.id]] = final_list
    end
  end
  $player.randomized_items = items
end

def pbRandomizeEncounters
  encounters = $player.wild_encounters
  pokemon = valid_pokemon
  encounters.each_value do |enc_data|
    enc_data[2].each_value do |type|
      type.each do |enc|
        enc[1] = pokemon.sample
      end
    end
  end
  $player.wild_encounters = encounters
end

def pbRandomizeAbilities
  species_abilities = $player.species_abilities
  abilities = valid_abilities
  new_abilities = abilities.clone.shuffle
  species_abilities.each_pair do |species_id, ability_data|
    ability_data[0].each_with_index do |ability, i|
      species_abilities[species_id][0][i] = new_abilities[abilities.find_index(ability)]
    end
    ability_data[1].each_with_index do |ability, i|
      species_abilities[species_id][1][i] = new_abilities[abilities.find_index(ability)]
    end
  end
  $player.species_abilities = species_abilities
end

def pbRandomizeTrainers
  trainers = pbGetDefaultTrainers
  pokemon = valid_pokemon(true)
  trainers.each_value do |trainer_data|
    trainer_data.each do |poke|
      next if poke[:species] == :STARTER || poke[:shadowness] == true
      poke[:species] = pokemon.sample
      poke[:moves] = []
    end
  end
  $player.trainer_pokemon = trainers
end

def pbRandomizeLearnsets
  learnsets = pbGetDefaultLearnsets
  moves = valid_moves
  new_moves = moves.clone.shuffle
  learnsets.each_pair do |species_id, move_data|
    move_data.each_with_index do |move, i|
      learnsets[species_id][i][1] = new_moves[moves.find_index(move[1])]
    end
    new_moves = new_moves.shuffle
  end
  $player.species_learnsets = learnsets
end

def pbRandomizeEvolutions
  evolutions = pbGetDefaultEvolutions
  pokemon = valid_pokemon(true)
  evolutions.each_pair do |species_id, evolution_data|
    evolutions[species_id] = [[pokemon.sample, :Level, 1, false]]
  end
  $player.species_evolutions = evolutions
end

def pbRandomizeItems
  items = $player.randomized_items
  available = valid_items
  items.each_pair do |key, value|
    items[key] = value.length.times.map { |i| available.sample }
  end
  $player.randomized_items = items
  special_items = $player.special_items
  special_items.each_pair do |key, value|
    if value.is_a?(Array)
      if value[0].is_a?(Array)
        special_items[key] = value.length.times.map { |i| value[i].length.times.map { |j| available.sample } }
      else
        special_items[key] = value.length.times.map { |i| available.sample }
      end
    elsif value.is_a?(Hash)
      special_items[key].each_pair do |key2, value2|
        if value2.is_a?(Array)
          special_items[key][key2] = value2.length.times.map { |i| value2[i].length.times.map { |j| available.sample } }
        elsif value2.is_a?(Hash)
          special_items[key][key2].each_pair do |key3, value3|
            special_items[key][key2][key3] = available.sample
          end
        else
          special_items[key][key2] = available.sample
        end
      end
    else
      special_items[key] = available.sample
    end
  end
end

def pbRandomizeMarts
  available = valid_items
  $player.shard_mart = ShardMart_Scene::DEFAULT_SHARD_MART.length.times.map { |i| available.sample }
  new_points = []
  PokemonMartAdapter_BattlePoints::DEFAULT_BATTLE_POINT_MART.each do |point|
    new_points.push(point.length.times.map { |i| available.sample })
  end
  $player.battle_point_mart = new_points
  new_stock = []
  DEFAULT_MART.each do |stock|
    new_stock.push(stock.length.times.map { |i| available.sample })
  end
  $player.mart_stock = new_stock
  $player.casino_mart = CASINO_MART.length.times.map { |i| available.sample }
end

EventHandlers.add(:on_enter_map, :randomized_items,
  proc {
    next unless $player.challenges
    next unless $player.randomizer_item
    $game_map.events.length.times do |i|
      items = $player.randomized_items[[$game_map.map_id, i]]
      next if items.nil?
      event = $game_map.events[i]
      pages = (event.is_a?(RPG::Event) ? event.pages : event.instance_eval { @event.pages })
      found_items = 0
      change_character = true
      pages.each do |page|
        list = page.list
        script = ""
        list.length.times do |i|
          next unless list[i].code == 111 || list[i].code == 355 || list[i].code == 655
          if list[i].code == 111
            next if list[i].parameters[0] != 12
            script = list[i].parameters[1]
          else
            next if list[i].parameters[0] == ""
            script = list[i].parameters[0]
          end
          next if script == ""
          [/pbItemBall/, /pbReceiveItem/, /vRI/, /vAI/, /vFI/, /$bag.add/, /pbPickBerry/].each do |c|
            next unless script[c]
            next if script.nil?
            old_item = script.gsub(/#{c}\(:/,"")
            next if old_item.nil?
            old_item.gsub!(/(?=[,)!]).*/,"").gsub(")", "")
            next if nil_or_empty?(old_item)
            old_item_data = GameData::Item.try_get(old_item)
            change_character = false if (old_item_data.is_important? && !old_item_data.is_TM?) || old_item_data.flags.include?("WeatherChip")
            next if old_item_data.nil? || (old_item_data.is_important? && !old_item_data.is_TM?) || old_item_data.flags.include?("WeatherChip")
            script = script.gsub(old_item.to_s, items[found_items].to_s)
            found_items += 1
            list[i].parameters[(list[i].code == 111 ? 1 : 0)] = script
          end
        end
        if page.graphic.character_name[/Item/i] && !$game_self_switches[[$game_map.map_id, i, "A"]] && change_character
          graphic_data = itemGraphic(GameData::Item.icon_filename(items[found_items-1]).gsub("Graphics/Items/","").to_sym)
          e = $game_map.events[i]
          e.character_name = graphic_data[0]
          e.direction = graphic_data[1]
          e.pattern = graphic_data[2]
        end
      end
    end
    $game_map.refresh
  }
)

def pbRandomizeSpecial
  special = $player.special_pokemon
  pokemon = valid_pokemon(true)
  special.each_pair do |key, value|
    if value.is_a?(Array)
      if value[0].is_a?(Array)
        special[key] = value.length.times.map { |i| value[i].length.times.map { |j| pokemon.sample } }
      else
        special[key] = value.length.times.map { |i| pokemon.sample }
      end
    elsif value.is_a?(Hash)
      special[key].each_pair do |key2, value2|
        if value2.is_a?(Array)
          special[key][key2] = value2.length.times.map { |i| value2[i].length.times.map { |j| pokemon.sample } }
        elsif value2.is_a?(Hash)
          special[key][key2].each_pair do |key3, value3|
            special[key][key2][key3] = value3.length.times.map { |i| pokemon.sample }
          end
        else
          special[key][key2] = value2.length.times.map { |i| pokemon.sample }
        end
      end
    else
      special[key] = pokemon.sample
    end
  end
  $player.special_pokemon = special
end

def pbRandomizeTMs
  tms = $player.tms
  moves = valid_moves
  tms.length.times do |i|
    tms[i] = moves.sample
  end
  $player.tms = tms
end